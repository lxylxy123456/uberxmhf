version: 2.1

jobs:
  test-xmhf:
    machine:
      # Need nested virtualization
      # https://discuss.circleci.com/t/new-android-machine-image-now-/39467
      image: android:2022.03.1
    resource_class: medium
    parameters:
      subarch:
        type: string
    steps:
      - checkout
      - run:
          name: sanity
          command: |
            rm -rf sanity_test
            mkdir sanity_test
            cd sanity_test
            /sbin/debugfs -V
            echo asdjf > jkl
            dd if=/dev/zero of=b.img bs=512K seek=1 count=0
            /sbin/mkfs.ext4 b.img
            echo AAAA
            echo write jkl jkl > my_script
            /sbin/debugfs -f my_script -w b.img
            echo BBBB
            echo cat jkl | /sbin/debugfs -w b.img | grep .
            echo CCCC
            echo ? | /sbin/debugfs -w b.img | grep .
            echo DDDD
            mkdir mnt
            sudo mount b.img mnt
            cat mnt/jkl
            xxd b.img | grep asdjf
      - run:
          name: sanity 2
          command: |
            cat /home/circleci/project/.jenkins/boot/grub/grub.cfg
      - run:
          name: "Apt-get"
          command: "
            sudo apt-get update && \
            sudo apt-get -y -q install \
                git crossbuild-essential-i386 \
                pbuilder texinfo ruby build-essential autoconf libtool \
                qemu-system-x86 sshpass xxd
          "
      - run:
          name: "Check"
          command: |
            python3 -u ./.jenkins/test3.py \
                --subarch ${SUBARCH} \
                --qemu-image ${PWD}/qemu/${qemu_image} \
                --qemu-image-back ${PWD}/qemu/${qemu_image_back} \
                --xmhf-bin ${PWD}/ \
                --sshpass jkl \
                --work-dir ${PWD}/tmp/ \
                --no-display \
                --verbose \
                --boot-dir ${PWD}/.jenkins/boot \
                --watch-serial \
                --skip-reset-qemu \
                --smp 2
      - run:
          name: "Build"
          command: "./.github/build.sh << parameters.subarch >> circleci"
      - run:
          name: "Versions"
          command: |
            lscpu
            ssh -V
            qemu-system-x86_64 -version
            gcc -v
      - store_artifacts:
          path: xmhf/src/xmhf-core/xmhf-runtime/runtime.exe
      - store_artifacts:
          path: xmhf/src/xmhf-core/xmhf-bootloader/init_syms.exe
      - store_artifacts:
          path: xmhf/src/xmhf-core/xmhf-secureloader/sl_syms.exe
      - store_artifacts:
          path: init-x86-amd64.bin
      - store_artifacts:
          path: hypervisor-x86-amd64.bin.gz
      - restore_cache:
          keys:
            - debian11x86x64-20220407-<< parameters.subarch >>
      - run:
          name: "Download Debian"
          command: |
            source .circleci/env.sh << parameters.subarch >>
            .jenkins/download.sh cache ${qemu_image_back}
      - save_cache:
          key: debian11x86x64-20220407-<< parameters.subarch >>
          paths:
            - cache/
      - run:
          name: "Test"
          command: |
            source .circleci/env.sh << parameters.subarch >>
            rm -rf tmp qemu
            mkdir tmp qemu
            ln -s ${PWD}/cache/${qemu_image_back} qemu
            qemu-img create -f qcow2 -b ${PWD}/qemu/${qemu_image_back} \
                            -F qcow2 ${PWD}/qemu/${qemu_image}
            sha512sum ${PWD}/qemu/${qemu_image_back}
            python3 -u ./.jenkins/test3.py \
                --subarch ${SUBARCH} \
                --qemu-image ${PWD}/qemu/${qemu_image} \
                --qemu-image-back ${PWD}/qemu/${qemu_image_back} \
                --xmhf-bin ${PWD}/ \
                --sshpass jkl \
                --work-dir ${PWD}/tmp/ \
                --no-display \
                --verbose \
                --boot-dir ${PWD}/.jenkins/boot \
                --watch-serial \
                --smp 2

workflows:
  test-xmhf-workflow:
    jobs:
      - test-xmhf:
          matrix:
            parameters:
              subarch: ["i386"]
