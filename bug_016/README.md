# HP GRUB graphical mode does not work

## Scope
* HP, x64 or x86 XMHF, Debian 11's GRUB
* good: QEMU, Debian 11's GRUB and Ubuntu's GRUB

## Behavior
If GRUB is not set to text mode (`GRUB_TERMINAL=console`), After selecting
`XMHF` or `XMHF64` in GRUB, the second GRUB menu does not appear.

## Debugging

### Intercept information

If using the following snippet to print all intercepts in
`xmhf_parteventhub_arch_x86_64vmx_intercept_handler()`, see
```c
	printf("\nIntercept 0x%x, 0x%08llx, 0x%02llx, 0x%llx", vcpu->id, vcpu->vmcs.guest_RIP, vcpu->vmcs.info_vmexit_reason, vcpu->vmcs.info_exit_qualification);
	if (vcpu->vmcs.info_vmexit_reason == 0xa) {
		printf("\tCPUID 0x%08x", r->eax);
	} else if (vcpu->vmcs.info_vmexit_reason == 0x1f) {
		printf("\tRDMSR 0x%08x", r->ecx);
	} else if (vcpu->vmcs.info_vmexit_reason == 0x20) {
		printf("\tWRMSR 0x%08x 0x%08x%08x", r->ecx, r->edx, r->eax);
	}
```

HP shows
```
...
Intercept 0x0, 0x000000ac, 0x12, 0x0
CPU(0x00): INT 15(e820): AX=0xe820, EDX=0x534d4150, EBX=0x00000011, ECX=0x00000014, ES=0x6800, DI=0x0004
Intercept 0x0, 0x000000ac, 0x12, 0x0
CPU(0x00): INT 15(e820): AX=0xe820, EDX=0x534d4150, EBX=0x00000012, ECX=0x00000014, ES=0x6800, DI=0x0004
Intercept 0x0, 0x00009ae7, 0x0a, 0x0	CPUID 0x00000001
Intercept 0x0, 0x00009af5, 0x0a, 0x0	CPUID 0x00000000
Intercept 0x0, 0x00009b36, 0x0a, 0x0	CPUID 0x00000000
Intercept 0x0, 0x00009b7b, 0x0a, 0x0	CPUID 0x00000000
Intercept 0x0, 0x00009a95, 0x0a, 0x0	CPUID 0x00000000
Intercept 0x0, 0x00009a95, 0x0a, 0x0	CPUID 0x00000000
(last line repeats another 70 times)
Intercept 0x0, 0x0fed3cac, 0x0a, 0x0	CPUID 0x00000001
Intercept 0x0, 0x0fed3cbd, 0x1f, 0x0	RDMSR 0x000000fe
Intercept 0x0, 0x0fed3cd7, 0x0a, 0x0	CPUID 0x80000000
Intercept 0x0, 0x0fed3cea, 0x0a, 0x0	CPUID 0x80000008
Intercept 0x0, 0x0fed3d52, 0x1f, 0x0	RDMSR 0x00000201
Intercept 0x0, 0x0fed3d6c, 0x1f, 0x0	RDMSR 0x00000200
Intercept 0x0, 0x0fed3d52, 0x1f, 0x0	RDMSR 0x00000203
Intercept 0x0, 0x0fed3d6c, 0x1f, 0x0	RDMSR 0x00000202
Intercept 0x0, 0x0fed3d52, 0x1f, 0x0	RDMSR 0x00000205
Intercept 0x0, 0x0fed3d6c, 0x1f, 0x0	RDMSR 0x00000204
Intercept 0x0, 0x0fed3d52, 0x1f, 0x0	RDMSR 0x00000207
Intercept 0x0, 0x0fed3d6c, 0x1f, 0x0	RDMSR 0x00000206
Intercept 0x0, 0x0fed3d52, 0x1f, 0x0	RDMSR 0x00000209
Intercept 0x0, 0x0fed3d6c, 0x1f, 0x0	RDMSR 0x00000208
Intercept 0x0, 0x0fed3d52, 0x1f, 0x0	RDMSR 0x0000020b
Intercept 0x0, 0x0fed3d6c, 0x1f, 0x0	RDMSR 0x0000020a
Intercept 0x0, 0x0fed3d52, 0x1f, 0x0	RDMSR 0x0000020d
Intercept 0x0, 0x0fed3d52, 0x1f, 0x0	RDMSR 0x0000020f
Intercept 0x0, 0x0fed3e11, 0x1f, 0x0	RDMSR 0x0000020c
Intercept 0x0, 0x0fed3e26, 0x1f, 0x0	RDMSR 0x0000020d
Intercept 0x0, 0x0fed3e60, 0x20, 0x0	WRMSR 0x0000020c 0x00000000c0000001
Intercept 0x0, 0x0fed3e8f, 0x20, 0x0	WRMSR 0x0000020d 0x0000000ffe010800
Intercept 0x0, 0x00009a95, 0x0a, 0x0	CPUID 0x00000000
Intercept 0x0, 0x00009a95, 0x0a, 0x0	CPUID 0x00000000
(last line repeats another 25 times)
```

HP text mode shows:
```
Intercept 0x0, 0x000000ac, 0x12, 0x0
CPU(0x00): INT 15(e820): AX=0xe820, EDX=0x534d4150, EBX=0x00000011, ECX=0x00000014, ES=0x6800, DI=0x0004
Intercept 0x0, 0x000000ac, 0x12, 0x0
CPU(0x00): INT 15(e820): AX=0xe820, EDX=0x534d4150, EBX=0x00000012, ECX=0x00000014, ES=0x6800, DI=0x0004
Intercept 0x0, 0x00009ae7, 0x0a, 0x0	CPUID 0x00000001
Intercept 0x0, 0x00009af5, 0x0a, 0x0	CPUID 0x00000000
Intercept 0x0, 0x00009b36, 0x0a, 0x0	CPUID 0x00000000
Intercept 0x0, 0x00009b7b, 0x0a, 0x0	CPUID 0x00000000
Intercept 0x0, 0x00009a95, 0x0a, 0x0	CPUID 0x00000000
Intercept 0x0, 0x00009a95, 0x0a, 0x0	CPUID 0x00000000
(then repeat the last lines forever, text mode is up)
```

QEMU graphical and text mode shows (same output)
```
...
Intercept 0x0, 0x000000ac, 0x12, 0x0
CPU(0x00): INT 15(e820): AX=0xe820, EDX=0x534d4150, EBX=0x00000007, ECX=0x00000014, ES=0x6800, DI=0x0004
Intercept 0x0, 0x000000ac, 0x12, 0x0
CPU(0x00): INT 15(e820): AX=0xe820, EDX=0x534d4150, EBX=0x00000008, ECX=0x00000014, ES=0x6800, DI=0x0004
Intercept 0x0, 0x00009ae7, 0x0a, 0x0	CPUID 0x00000001
Intercept 0x0, 0x00009af5, 0x0a, 0x0	CPUID 0x00000000
Intercept 0x0, 0x00009b36, 0x0a, 0x0	CPUID 0x00000000
Intercept 0x0, 0x00009b7b, 0x0a, 0x0	CPUID 0x00000000
Intercept 0x0, 0x00009a95, 0x0a, 0x0	CPUID 0x00000000
Intercept 0x0, 0x00009a95, 0x0a, 0x0	CPUID 0x00000000
(then repeat the last lines forever, graphics / text mode is up)
```

Can see that in all 4 combinations's first few lines are the same. But suddenly
HP graphics mode executes some code in `0x0fed3cac`, to read MTRRs.

### Debugger

By invoking a debugger / printing CR0, can see that code are executed in
protected mode. `CS = 0x0008`, there are no offset in GDT.

In QEMU can print code in `0x00009a95`, but cannot print code in `0x0fed3cac`.
However, not sure whether MTRRs are related to the problem.

For next step, need to find a way to see RIP of CPU 0 after HP graphics mode
stucks. May need to set a timer and cause intercept.

## Result

Less important feature to fix, skipped for now

